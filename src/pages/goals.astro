---
import DefaultLayout from "../layouts/DefaultLayout.astro";

const title = "Annual Goals";
---

<DefaultLayout title={title}>
  <section class="workspace-header">
    <h1>Annual Goals</h1>
  </section>

  <section class="workspace-content">
    <!-- State Navigation -->
    <div class="card" style="grid-column: span 12;">
      <div style="display: flex; justify-content: center; gap: 0.5rem;">
        <div class="pill active" onclick="navigateToPhase('build-plan')">
          Build Plan
        </div>
        <div class="pill" onclick="navigateToPhase('mid-year')">
          Mid-Year Review
        </div>
        <div class="pill" onclick="navigateToPhase('end-of-year')">
          End-of-Year Review
        </div>
      </div>
    </div>

    <!-- Manager Goals Section -->
    <div class="card" style="grid-column: span 12;">
      <div
        style="display: flex; justify-content: space-between; align-items: center;"
      >
        <h3>Manager's Goals</h3>
        <button
          type="button"
          class="btn btn-sm btn-outline"
          onclick="toggleManagerGoals()"
        >
          <span id="manager-toggle">−</span>
        </button>
      </div>
      <div id="managerGoalsContent">
        <div id="managerGoalsSection">
          <div class="loading">Loading manager's goals...</div>
        </div>
      </div>
    </div>

    <!-- My Goals Section -->
    <div class="card" style="grid-column: span 12;">
      <div
        style="display: flex; justify-content: space-between; align-items: center;"
      >
        <h3>My Goals</h3>
        <div style="display: flex; gap: 0.5rem;">
          <button
            type="button"
            class="btn btn-sm btn-success"
            onclick="addEmployeeGoal()"
          >
            + Add Goal
          </button>
          <button
            type="button"
            class="btn btn-sm btn-outline"
            onclick="toggleMyGoals()"
          >
            <span id="my-toggle">−</span>
          </button>
        </div>
      </div>
      <div id="myGoalsContent">
        <div id="myGoalsSection">
          <div class="loading">Loading your goals...</div>
        </div>
      </div>
    </div>
  </section>
</DefaultLayout>

<script>
  // @ts-nocheck
  // Disable TypeScript checking for this complex legacy file
  // TODO: Refactor to proper TypeScript in the future

  const EMPLOYEE_ID = 301;
  let currentState = "build-plan";

  console.log("Script started");

  async function loadGoalsData() {
    try {
      console.log("Loading goals data...");
      const url = `http://localhost:3001/api/goals?employee_id=${EMPLOYEE_ID}&state=${currentState}`;
      console.log("Fetching from URL:", url);

      const response = await fetch(url);
      console.log("Response status:", response.status);
      console.log("Response ok:", response.ok);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log("Goals data received:", data);
      console.log("Manager goals:", data.managerGoals);
      console.log("My goals:", data.goals || data.myGoals);

      // Display manager goals
      console.log("About to display manager goals...");
      displayManagerGoals(data.managerGoals || []);

      // Store goals data globally for edit functionality
      window.goalsData = data;

      // Display my goals
      console.log("About to display my goals...");
      displayMyGoals(data.goals || data.myGoals || []);
    } catch (error) {
      console.error("Error loading goals:", error);
      const managerSection = document.getElementById("managerGoalsSection");
      const mySection = document.getElementById("myGoalsSection");
      const errorMessage =
        error instanceof Error ? error.message : "Unknown error";

      if (managerSection) {
        managerSection.innerHTML =
          '<div style="color: red;">Error loading manager goals: ' +
          errorMessage +
          "</div>";
      }
      if (mySection) {
        mySection.innerHTML =
          '<div style="color: red;">Error loading goals: ' +
          errorMessage +
          "</div>";
      }
    }
  }

  function displayManagerGoals(managerGoals) {
    console.log("displayManagerGoals called with:", managerGoals);
    const section = document.getElementById("managerGoalsSection");

    if (!managerGoals || managerGoals.length === 0) {
      section.innerHTML =
        '<div style="color: var(--gray-500); font-style: italic; padding: 1rem; text-align: center;">No manager goals available for this review period.</div>';
      return;
    }

    // Sort goals alphabetically by strategy name
    const sortedManagerGoals = [...managerGoals].sort((a, b) => {
      const strategyA = (a.strategy_name || "").toLowerCase();
      const strategyB = (b.strategy_name || "").toLowerCase();
      return strategyA.localeCompare(strategyB);
    });

    let html =
      '<div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem;">';
    sortedManagerGoals.forEach((goal, index) => {
      const goalId = `manager-goal-${index}`;
      html += `
        <div style="padding: 1rem; border: 1px solid var(--gray-200); border-radius: 10px; background: var(--gray-50);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div style="flex: 1; display: flex; gap: 2rem;">
              <div style="flex: 1;">
                <h3 style="margin-bottom: 0.4rem;">Strategy</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.strategy_name || "No strategy specified"}</div>
              </div>
              <div style="flex: 3;">
                <h3 style="margin-bottom: 0.4rem;">Objective</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.objective || "Untitled Goal"}</div>
              </div>
              <div style="flex: 1; margin-left: 2rem;">
                <h3 style="margin-bottom: 0.4rem;">Date</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${
                  goal.target_date && goal.target_date !== "null"
                    ? (() => {
                        try {
                          const dateStr = goal.target_date.split("T")[0];
                          return new Date(
                            dateStr + "T12:00:00"
                          ).toLocaleDateString();
                        } catch (e) {
                          return "Invalid date";
                        }
                      })()
                    : "No date set"
                }</div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
              <button class="btn btn-sm btn-outline" style="visibility: hidden;">Delete</button>
              <button class="btn btn-sm btn-outline" style="visibility: hidden;">Edit</button>
              <button class="btn btn-sm btn-outline toggle-goal-btn" data-goal-id="${goalId}">
                <span class="toggle-icon">\u2212</span>
              </button>
            </div>
          </div>
          <div id="details-${goalId}" style="margin-top: 1rem;">
            <div>
              <h3 style="margin-bottom: 0.4rem;">Description</h3>
              <div style="font-size: 1rem; font-weight: 500; color: var(--gray-700); line-height: 1.3;">${goal.goal_description || "No description provided"}</div>
            </div>
          </div>
        </div>
      `;
    });
    html += "</div>";

    section.innerHTML = html;
  }

  function displayMyGoals(myGoals) {
    console.log("displayMyGoals called with:", myGoals);
    const mySection = document.getElementById("myGoalsSection");

    if (!myGoals || myGoals.length === 0) {
      mySection.innerHTML =
        '<div style="color: var(--gray-500); font-style: italic; padding: 1rem; text-align: center;">No goals set yet. Click "Add New Goal" to get started.</div>';
      return;
    }

    // Sort goals alphabetically by strategy name
    const sortedMyGoals = [...myGoals].sort((a, b) => {
      const strategyA = (a.strategy_name || "").toLowerCase();
      const strategyB = (b.strategy_name || "").toLowerCase();
      return strategyA.localeCompare(strategyB);
    });

    let html =
      '<div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem;">';
    sortedMyGoals.forEach((goal, index) => {
      const goalId = `my-goal-${index}`;
      html += `
        <div style="padding: 1rem; border: 1px solid var(--gray-200); border-radius: 10px; background: var(--gray-50);" data-goal-id="${goal.goal_id}">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div style="flex: 1; display: flex; gap: 2rem;">
              <div style="flex: 1;">
                <h3 style="margin-bottom: 0.4rem;">Strategy</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.strategy_name || "No strategy specified"}</div>
              </div>
              <div style="flex: 3;">
                <h3 style="margin-bottom: 0.4rem;">Objective</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.objective || "Untitled Goal"}</div>
              </div>
              <div style="flex: 1; margin-left: 2rem;">
                <h3 style="margin-bottom: 0.4rem;">Date</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${
                  goal.target_date && goal.target_date !== "null"
                    ? (() => {
                        try {
                          const dateStr = goal.target_date.split("T")[0];
                          return new Date(
                            dateStr + "T12:00:00"
                          ).toLocaleDateString();
                        } catch (e) {
                          return "Invalid date";
                        }
                      })()
                    : "No date set"
                }</div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
              <button class="btn btn-sm btn-outline" onclick="deleteGoal(${goal.goal_id})">Delete</button>
              <button class="btn btn-sm btn-outline" onclick="editGoal(${goal.goal_id})">Edit</button>
              <button class="btn btn-sm btn-outline toggle-goal-btn" data-goal-id="${goalId}">
                <span class="toggle-icon">\u2212</span>
              </button>
            </div>
          </div>
          <div id="details-${goalId}" style="margin-top: 1rem;">
            <div>
              <h3 style="margin-bottom: 0.4rem;">Description</h3>
              <div style="font-size: 1rem; font-weight: 500; color: var(--gray-700); line-height: 1.3;">${goal.goal_description || "No description provided"}</div>
            </div>
          </div>
        </div>
      `;
    });
    html += "</div>";

    mySection.innerHTML = html;
  }

  let currentlyEditing = null;

  window.deleteGoal = async function (goalId) {
    console.log("Deleting goal with ID:", goalId);

    // Show confirmation dialog
    if (
      !confirm(
        "Are you sure you want to delete this goal? This action cannot be undone."
      )
    ) {
      return;
    }

    try {
      const response = await fetch(
        `http://localhost:3001/api/goals/${goalId}`,
        {
          method: "DELETE",
          headers: {
            "Content-Type": "application/json",
          },
        }
      );

      console.log("Delete response status:", response.status);

      if (response.ok) {
        console.log("Goal deleted successfully");
        // Reload goals to refresh the display
        loadGoalsData();
      } else {
        const errorData = await response.text();
        console.error("Failed to delete goal:", errorData);
        alert("Failed to delete goal: " + errorData);
      }
    } catch (error) {
      console.error("Error deleting goal:", error);
      alert(
        "Error deleting goal: " +
          (error instanceof Error ? error.message : "Unknown error")
      );
    }
  };

  window.editGoal = function (goalId) {
    console.log("Editing goal with ID:", goalId);
    console.log("Looking for div with data-goal-id:", goalId);

    // Cancel any existing edit
    if (currentlyEditing) {
      cancelEdit(currentlyEditing);
    }

    currentlyEditing = goalId;

    // Find the goal data
    console.log("Looking for goal ID:", goalId, "in data:", window.goalsData);
    const myGoals =
      (window.goalsData &&
        (window.goalsData.goals || window.goalsData.myGoals)) ||
      [];
    console.log("Available goals:", myGoals);
    // Try both possible field names
    const goal = myGoals.find((g) => g.goal_id === goalId || g.id === goalId);
    console.log("Found goal:", goal);

    if (!goal) {
      alert("Goal not found!");
      return;
    }

    // Generate strategies dropdown options
    const strategies = (window.goalsData && window.goalsData.strategies) || [];
    let strategiesOptions = "";
    strategies.forEach((strategy) => {
      const selected =
        strategy.strategy_id === goal.strategy_id ? "selected" : "";
      strategiesOptions += `<option value="${strategy.strategy_id}" ${selected}>${strategy.strategy_name}</option>`;
    });

    // Create edit form
    const editForm = `
        <div style="padding: 1rem; border: 1px solid var(--blue-accent); border-radius: 10px; background: var(--gray-50); margin-top: 0.5rem;">
                    <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.75rem; color: var(--gray-600); font-weight: 500; margin-bottom: 0.3rem; display: block;" for="editObjective">Objective</label>
            <input type="text" id="editObjective" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-200); border-radius: calc(var(--radius) / 2); font-size: 0.9rem;" value="${goal.objective || ""}">
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.75rem; color: var(--gray-600); font-weight: 500; margin-bottom: 0.3rem; display: block;" for="editDescription">Description</label>
            <textarea id="editDescription" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-200); border-radius: calc(var(--radius) / 2); font-size: 0.9rem; min-height: 80px; resize: vertical;" rows="3">${goal.goal_description || ""}</textarea>
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.75rem; color: var(--gray-600); font-weight: 500; margin-bottom: 0.3rem; display: block;" for="editStrategy">Strategy</label>
            <select id="editStrategy" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-200); border-radius: calc(var(--radius) / 2); font-size: 0.9rem;">
              <option value="">Select a strategy...</option>
              ${strategiesOptions}
            </select>
          </div>
          <div style="margin-bottom: 1rem;">
            <label style="font-size: 0.75rem; color: var(--gray-600); font-weight: 500; margin-bottom: 0.3rem; display: block;" for="editCompletionDate">Completion Date</label>
                        <input type="date" id="editCompletionDate" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-200); border-radius: calc(var(--radius) / 2); font-size: 0.9rem;" value="${
                          goal.target_date && goal.target_date !== "null"
                            ? (() => {
                                try {
                                  return goal.target_date.split("T")[0];
                                } catch (e) {
                                  return "";
                                }
                              })()
                            : ""
                        }">
          </div>
          <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button type="button" class="btn btn-success" onclick="saveGoal(${goalId})">Save Draft</button>
            <button type="button" class="btn btn-outline" onclick="cancelEdit(${goalId})">Cancel</button>
          </div>
        </div>
      `;

    // Replace the goal content with edit form
    const goalDiv = document.querySelector(`[data-goal-id="${goalId}"]`);
    if (goalDiv) {
      goalDiv.innerHTML = editForm;
    } else {
      console.error("Could not find goal div with data-goal-id:", goalId);
    }
  };

  window.saveGoal = async function (goalId) {
    console.log("Saving goal:", goalId);

    try {
      const objectiveInput = document.getElementById("editObjective");
      const descriptionInput = document.getElementById("editDescription");
      const strategySelect = document.getElementById("editStrategy");
      const completionDateInput = document.getElementById("editCompletionDate");

      if (
        !objectiveInput ||
        !descriptionInput ||
        !strategySelect ||
        !completionDateInput
      ) {
        alert("Could not find form elements");
        return;
      }

      const objective = objectiveInput.value;
      const description = descriptionInput.value;
      const strategy_id = strategySelect.value;
      const target_date = completionDateInput.value;

      const response = await fetch(
        `http://localhost:3001/api/goals/${goalId}`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            objective: objective,
            goal_description: description,
            strategy_id: strategy_id || null,
            target_date: target_date || null,
          }),
        }
      );

      if (response.ok) {
        // Reset editing state
        currentlyEditing = null;
        // Reload the goals to show updated data
        await loadGoalsData();
      } else {
        const errorData = await response.text();
        alert("Failed to save goal: " + errorData);
      }
    } catch (error) {
      console.error("Error saving goal:", error);
      alert(
        "Error saving goal: " +
          (error instanceof Error ? error.message : "Unknown error")
      );
    }
  };

  window.cancelEdit = function (goalId) {
    console.log("Cancelling edit for goal:", goalId);
    currentlyEditing = null;
    // Reload goals to restore original view
    loadGoalsData();
  };

  window.addEmployeeGoal = function () {
    console.log("Adding new employee goal");

    // Get strategies from the loaded goals data
    const strategies = window.goalsData?.strategies || [];
    console.log("Available strategies:", strategies);

    // Build strategy options
    let strategyOptions = '<option value="">Select Strategy</option>';
    strategies.forEach((strategy) => {
      strategyOptions += `<option value="${strategy.strategy_id}">${strategy.strategy_name}</option>`;
    });

    // Create a simple form for adding a new goal
    const form = `
      <div style="padding: 1rem; border: 2px solid var(--blue-primary); border-radius: 10px; background: var(--gray-50); margin-top: 1rem;">
        <h4 style="margin-bottom: 1rem;">Add New Goal</h4>
        
        <div style="margin-bottom: 1rem;">
          <label style="font-size: 0.875rem; color: var(--gray-600); font-weight: 500; margin-bottom: 0.5rem; display: block;">Strategy</label>
          <select id="newGoalStrategy" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 5px;">
            ${strategyOptions}
          </select>
        </div>        <div style="margin-bottom: 1rem;">
          <label style="font-size: 0.875rem; color: var(--gray-600); font-weight: 500; margin-bottom: 0.5rem; display: block;">Objective</label>
          <input type="text" id="newGoalObjective" placeholder="Enter objective..." style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 5px;">
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="font-size: 0.875rem; color: var(--gray-600); font-weight: 500; margin-bottom: 0.5rem; display: block;">Description</label>
          <textarea id="newGoalDescription" placeholder="Enter description..." rows="3" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 5px; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 1rem;">
          <label style="font-size: 0.875rem; color: var(--gray-600); font-weight: 500; margin-bottom: 0.5rem; display: block;">Completion Date</label>
          <input type="date" id="newGoalCompletionDate" style="width: 100%; padding: 0.5rem; border: 1px solid var(--gray-300); border-radius: 5px;">
        </div>

        <div style="display: flex; gap: 0.5rem;">
          <button class="btn btn-sm btn-success" onclick="saveNewGoal()">Save Goal</button>
          <button class="btn btn-sm btn-outline" onclick="cancelAddGoal()">Cancel</button>
        </div>
      </div>
    `;

    // Add the form to the My Goals section
    const mySection = document.getElementById("myGoalsSection");
    if (mySection) {
      mySection.insertAdjacentHTML("beforeend", form);
    }
  };

  window.saveNewGoal = async function () {
    console.log("Saving new goal");

    const strategyId = document.getElementById("newGoalStrategy").value;
    const objective = document.getElementById("newGoalObjective").value;
    const description = document.getElementById("newGoalDescription").value;
    const completionDate = document.getElementById(
      "newGoalCompletionDate"
    ).value;

    if (!strategyId || !objective.trim()) {
      alert("Please fill in Strategy and Objective fields");
      return;
    }

    try {
      const requestBody = {
        employee_id: 301, // TODO: Get this dynamically
        review_cycle_id: 1, // TODO: Get this dynamically (for now using 1)
        strategy_id: parseInt(strategyId),
        objective: objective.trim(),
        goal_description: description.trim(),
        target_date: completionDate || null,
      };

      console.log("Sending request:", requestBody);

      const response = await fetch("http://localhost:3001/api/goals", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(requestBody),
      });

      console.log("Response status:", response.status);

      if (!response.ok) {
        const errorText = await response.text();
        console.error("Error response:", errorText);
        throw new Error(
          `HTTP error! status: ${response.status}, message: ${errorText}`
        );
      }

      const result = await response.json();
      console.log("Goal created successfully:", result);

      // Remove the form and reload goals
      cancelAddGoal();
      loadGoalsData();
    } catch (error) {
      console.error("Error creating goal:", error);
      alert(
        "Error creating goal. Please check the browser console for details."
      );
    }
  };

  window.cancelAddGoal = function () {
    // Remove the add goal form
    const forms = document.querySelectorAll(
      'div[style*="border: 2px solid var(--blue-primary)"]'
    );
    forms.forEach((form) => form.remove());
  };

  // Toggle section collapse/expand
  window.toggleManagerGoals = function () {
    const content = document.getElementById("managerGoalsContent");
    const toggle = document.getElementById("manager-toggle");

    if (content && toggle) {
      if (content.classList.contains("collapsed")) {
        content.classList.remove("collapsed");
        toggle.textContent = "−";
      } else {
        content.classList.add("collapsed");
        toggle.textContent = "+";
      }
    }
  };

  window.toggleMyGoals = function () {
    const content = document.getElementById("myGoalsContent");
    const toggle = document.getElementById("my-toggle");

    if (content && toggle) {
      if (content.classList.contains("collapsed")) {
        content.classList.remove("collapsed");
        toggle.textContent = "−";
      } else {
        content.classList.add("collapsed");
        toggle.textContent = "+";
      }
    }
  };

  // Event delegation for toggle buttons
  document.addEventListener("click", function (e) {
    const target = e.target;
    if (!target) return;

    // Check if clicked element or its parent is a toggle button
    let button = null;
    if (target.classList && target.classList.contains("toggle-goal-btn")) {
      button = target;
    } else if (
      target.parentElement &&
      target.parentElement.classList &&
      target.parentElement.classList.contains("toggle-goal-btn")
    ) {
      button = target.parentElement;
    }

    if (button) {
      const goalId = button.getAttribute("data-goal-id");
      console.log("Toggle button clicked for goal:", goalId);

      const details = document.getElementById(`details-${goalId}`);
      const toggleIcon = button.querySelector(".toggle-icon");

      console.log("Found elements:", { details, toggleIcon, goalId });

      if (details && toggleIcon) {
        if (
          details.style.display === "none" ||
          details.classList.contains("collapsed")
        ) {
          console.log("Expanding goal details");
          details.style.display = "block";
          details.classList.remove("collapsed");
          toggleIcon.textContent = "\u2212";
        } else {
          console.log("Collapsing goal details");
          details.style.display = "none";
          details.classList.add("collapsed");
          toggleIcon.textContent = "+";
        }
      } else {
        console.log("Could not find details or toggle elements", {
          details,
          toggleIcon,
          goalId,
        });
      }
    }
  });

  // Navigation function for pills
  window.navigateToPhase = function (phase) {
    console.log("Navigating to phase:", phase);

    if (phase === "build-plan") {
      // Already on build plan page, just reload if needed
      return;
    } else if (phase === "mid-year") {
      window.location.href = "/midyear";
    } else if (phase === "end-of-year") {
      window.location.href = "/endyear";
    }
  };

  document.addEventListener("DOMContentLoaded", () => {
    console.log("DOM ready");
    document.getElementById("managerGoalsSection").innerHTML =
      '<div class="loading">Loading manager\'s goals...</div>';
    document.getElementById("myGoalsSection").innerHTML =
      '<div class="loading">Loading your goals...</div>';
    loadGoalsData();
  });
</script>

<style>
  .pill.active {
    background: var(--blue-primary);
    color: white;
    border-color: var(--blue-primary);
  }

  .pill.disabled {
    background: var(--gray-200);
    color: var(--gray-500);
    border-color: var(--gray-200);
    cursor: not-allowed;
  }

  .collapsed {
    display: none;
  }

  .loading {
    color: var(--gray-500);
    font-style: italic;
    padding: 1rem;
    text-align: center;
  }
</style>
