---
import DefaultLayout from "../layouts/DefaultLayout.astro";
---

<DefaultLayout title="End-of-Year Review">
  <section class="workspace-header">
    <h1>End-of-Year Review</h1>
  </section>

  <section class="workspace-content">
    <!-- State Navigation -->
    <div class="card" style="grid-column: span 12;">
      <div style="display: flex; justify-content: center; gap: 0.5rem;">
        <div class="pill" onclick="navigateToPhase('build-plan')">
          Build Plan
        </div>
        <div class="pill" onclick="navigateToPhase('mid-year')">
          Mid-Year Review
        </div>
        <div class="pill active" onclick="navigateToPhase('end-of-year')">
          End-of-Year Review
        </div>
      </div>
    </div>

    <!-- Manager Goals Section (Read Only) -->
    <div class="card" style="grid-column: span 12;">
      <div
        style="display: flex; justify-content: space-between; align-items: center;"
      >
        <h3>Manager Goals</h3>
        <button
          type="button"
          class="btn btn-sm btn-outline"
          onclick="toggleManagerGoals()"
        >
          <span id="manager-toggle">−</span>
        </button>
      </div>
      <div id="managerGoalsContent">
        <div id="managerGoalsSection">
          <div class="loading">Loading manager goals...</div>
        </div>
      </div>
    </div>

    <!-- My Goals Section (View Ratings & Manager Rating) -->
    <div class="card" style="grid-column: span 12;">
      <div
        style="display: flex; justify-content: space-between; align-items: center;"
      >
        <h3>My Goals - Final Review</h3>
        <button
          type="button"
          class="btn btn-sm btn-outline"
          onclick="toggleMyGoals()"
        >
          <span id="my-toggle">−</span>
        </button>
      </div>
      <div id="myGoalsContent">
        <div id="myGoalsSection">
          <div class="loading">Loading your goals...</div>
        </div>
      </div>
    </div>

    <!-- My Overall Comments and Rating -->
    <div class="card" style="grid-column: span 6;">
      <h3>My Overall Comments & Rating</h3>
      <div id="myOverallSection">
        <div style="margin-top: 1rem;">
          <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;"
          >
            <h4 style="margin: 0;">Overall Comments</h4>
            <button
              class="btn btn-sm btn-outline"
              onclick="toggleMyOverallCommentsEdit()"
              id="myCommentsEditBtn"
            >
              Edit
            </button>
          </div>
          <textarea
            id="myOverallComments"
            placeholder="Share your overall thoughts on this review period..."
            style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px; font-family: inherit; resize: none; overflow: hidden; background: var(--gray-50);"
            readonly></textarea>
        </div>
        <div style="margin-top: 1rem;">
          <h4 style="margin-bottom: 0.5rem;">Overall Self-Rating</h4>
          <div
            id="myOverallRating"
            style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); margin-bottom: 0.5rem;"
          >
            Not rated
          </div>
          <button class="btn btn-sm btn-primary" onclick="rateOverallSelf()"
            >Rate Overall Performance</button
          >
        </div>
      </div>
    </div>

    <!-- Manager Overall Comments and Rating -->
    <div class="card" style="grid-column: span 6;">
      <h3>Manager Overall Comments & Rating</h3>
      <div id="managerOverallSection">
        <div style="margin-top: 1rem;">
          <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;"
          >
            <h4 style="margin: 0;">Manager Comments</h4>
            <button
              class="btn btn-sm btn-outline"
              onclick="toggleManagerOverallCommentsEdit()"
              id="managerCommentsEditBtn"
            >
              Edit
            </button>
          </div>
          <textarea
            id="managerOverallComments"
            placeholder="Manager's overall assessment will appear here..."
            style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid var(--gray-300); border-radius: 6px; font-family: inherit; resize: none; overflow: hidden; background: var(--gray-50);"
            readonly></textarea>
        </div>
        <div style="margin-top: 1rem;">
          <h4 style="margin-bottom: 0.5rem;">Manager Overall Rating</h4>
          <div
            id="managerOverallRating"
            style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); margin-bottom: 0.5rem;"
          >
            Pending
          </div>
          <button
            class="btn btn-sm btn-primary"
            onclick="rateOverallAsManager()">Rate as Manager</button
          >
        </div>
      </div>
    </div>
  </section>
</DefaultLayout>

<script>
  const EMPLOYEE_ID = 301;
  let currentState = "end-year";

  console.log("End-of-Year Review script started");

  async function loadGoalsData() {
    try {
      console.log("Loading goals data for end-of-year review...");
      const url = `http://localhost:3001/api/goals?employee_id=${EMPLOYEE_ID}&state=${currentState}`;
      console.log("Fetching from URL:", url);

      const response = await fetch(url);
      console.log("Response status:", response.status);
      console.log("Response ok:", response.ok);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log("Goals data received:", data);

      // Store globally for other functions
      window.goalsData = data;

      // Display manager goals (read-only)
      displayManagerGoals(data.managerGoals || []);

      // Display employee goals with both ratings
      displayMyGoalsWithBothRatings(data.myGoals || []);

      // Show rating scale
      displayRatingScale(data.ratingScale || []);

      // Display overall comments and ratings immediately
      console.log("Setting up overall data with:", data.reviewData);

      // Direct and immediate approach
      const empRatingEl = document.getElementById("myOverallRating");
      const mgmtRatingEl = document.getElementById("managerOverallRating");

      if (empRatingEl) {
        const empRating = data.reviewData?.employee_overall_rating;
        console.log("Employee rating value:", empRating);
        empRatingEl.textContent =
          empRating !== null && empRating !== undefined
            ? String(empRating)
            : "Not rated";
        console.log(
          "Employee rating element now shows:",
          empRatingEl.textContent
        );
      }

      if (mgmtRatingEl) {
        const mgmtRating = data.reviewData?.manager_overall_rating;
        console.log("Manager rating value:", mgmtRating);
        mgmtRatingEl.textContent =
          mgmtRating !== null && mgmtRating !== undefined
            ? String(mgmtRating)
            : "Pending";
        console.log(
          "Manager rating element now shows:",
          mgmtRatingEl.textContent
        );
      }

      // Set up comments
      const empCommentsEl = document.getElementById("myOverallComments");
      const mgmtCommentsEl = document.getElementById("managerOverallComments");

      if (empCommentsEl) {
        empCommentsEl.value = data.reviewData?.employee_overall_comments || "";
        autoResizeTextarea(empCommentsEl);
      }

      if (mgmtCommentsEl) {
        mgmtCommentsEl.value = data.reviewData?.manager_overall_comments || "";
        autoResizeTextarea(mgmtCommentsEl);
      }

      setupOverallCommentsHandlers();
    } catch (error) {
      console.error("Error loading goals data:", error);
      const managerSection = document.getElementById("managerGoalsSection");
      const mySection = document.getElementById("myGoalsSection");

      if (managerSection) {
        managerSection.innerHTML =
          '<div style="color: red; padding: 1rem;">Error loading manager goals: ' +
          (error instanceof Error ? error.message : "Unknown error") +
          "</div>";
      }

      if (mySection) {
        mySection.innerHTML =
          '<div style="color: red; padding: 1rem;">Error loading your goals: ' +
          (error instanceof Error ? error.message : "Unknown error") +
          "</div>";
      }
    }
  }

  function displayManagerGoals(managerGoals) {
    console.log("displayManagerGoals called with:", managerGoals);
    const section = document.getElementById("managerGoalsSection");

    if (!managerGoals || managerGoals.length === 0) {
      section.innerHTML =
        '<div style="color: var(--gray-500); font-style: italic; padding: 1rem; text-align: center;">No manager goals available for this review period.</div>';
      return;
    }

    // Sort goals alphabetically by strategy name
    const sortedManagerGoals = [...managerGoals].sort((a, b) => {
      const strategyA = (a.strategy_name || "").toLowerCase();
      const strategyB = (b.strategy_name || "").toLowerCase();
      return strategyA.localeCompare(strategyB);
    });

    let html =
      '<div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem;">';
    sortedManagerGoals.forEach((goal, index) => {
      const goalId = `manager-goal-${index}`;
      html += `
        <div style="padding: 1rem; border: 1px solid var(--gray-200); border-radius: 10px; background: var(--gray-50);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div style="flex: 1; display: flex; gap: 2rem;">
              <div style="flex: 1;">
                <h3 style="margin-bottom: 0.4rem;">Strategy</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.strategy_name || "No strategy specified"}</div>
              </div>
              <div style="flex: 3;">
                <h3 style="margin-bottom: 0.4rem;">Objective</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.objective || "Untitled Goal"}</div>
              </div>
              <div style="flex: 1; margin-left: 2rem;">
                <h3 style="margin-bottom: 0.4rem;">Date</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${
                  goal.target_date && goal.target_date !== "null"
                    ? (() => {
                        try {
                          const dateStr = goal.target_date.split("T")[0];
                          return new Date(
                            dateStr + "T12:00:00"
                          ).toLocaleDateString();
                        } catch (e) {
                          return "Invalid date";
                        }
                      })()
                    : "No date set"
                }</div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
              <button class="btn btn-sm btn-outline toggle-goal-btn" data-goal-id="${goalId}">
                <span class="toggle-icon">\u2212</span>
              </button>
            </div>
          </div>
          <div id="details-${goalId}" style="margin-top: 1rem;">
            <div>
              <h3 style="margin-bottom: 0.4rem;">Description</h3>
              <div style="font-size: 1rem; font-weight: 500; color: var(--gray-700); line-height: 1.3;">${goal.goal_description || "No description provided"}</div>
            </div>
          </div>
        </div>
      `;
    });
    html += "</div>";

    section.innerHTML = html;
  }

  function displayMyGoalsWithBothRatings(myGoals) {
    console.log("displayMyGoalsWithBothRatings called with:", myGoals);
    const mySection = document.getElementById("myGoalsSection");

    if (!myGoals || myGoals.length === 0) {
      mySection.innerHTML =
        '<div style="color: var(--gray-500); font-style: italic; padding: 1rem; text-align: center;">No goals found for end-of-year review.</div>';
      return;
    }

    // Sort goals alphabetically by strategy name
    const sortedMyGoals = [...myGoals].sort((a, b) => {
      const strategyA = (a.strategy_name || "").toLowerCase();
      const strategyB = (b.strategy_name || "").toLowerCase();
      return strategyA.localeCompare(strategyB);
    });

    let html =
      '<div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem;">';
    sortedMyGoals.forEach((goal, index) => {
      const goalId = `my-goal-${index}`;
      html += `
        <div style="padding: 1rem; border: 1px solid var(--gray-200); border-radius: 10px; background: var(--gray-50);" data-goal-id="${goal.goal_id}">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div style="flex: 1; display: flex; gap: 2rem;">
              <div style="flex: 1;">
                <h3 style="margin-bottom: 0.4rem;">Strategy</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.strategy_name || "No strategy specified"}</div>
              </div>
              <div style="flex: 3;">
                <h3 style="margin-bottom: 0.4rem;">Objective</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.objective || "Untitled Goal"}</div>
              </div>
              <div style="flex: 1; margin-left: 2rem; text-align: center;">
                <h3 style="margin-bottom: 0.4rem;">My Rating</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">
                  ${goal.employee_rating || "Not rated"}
                </div>
                <h3 style="margin-bottom: 0.4rem; margin-top: 1rem;">Manager Rating</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">
                  ${goal.manager_rating || "Pending"}
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
              <button class="btn btn-sm btn-primary" onclick="rateGoalAsEmployee(${goal.goal_id})">Rate</button>
              <button class="btn btn-sm btn-outline" onclick="rateGoalAsManager(${goal.goal_id})">Rate as Manager</button>
              <button class="btn btn-sm btn-outline toggle-goal-btn" data-goal-id="${goalId}">
                <span class="toggle-icon">\u2212</span>
              </button>
            </div>
          </div>
          <div id="details-${goalId}" style="margin-top: 1rem;">
            <div>
              <h3 style="margin-bottom: 0.4rem;">Description</h3>
              <div style="font-size: 1rem; font-weight: 500; color: var(--gray-700); line-height: 1.3;">${goal.goal_description || "No description provided"}</div>
            </div>
          </div>
        </div>
      `;
    });
    html += "</div>";

    mySection.innerHTML = html;
  }

  // Auto-resize textarea function
  function autoResizeTextarea(textarea) {
    if (!textarea) return;

    // Reset height to recalculate
    textarea.style.height = "auto";

    // Set height to scroll height (content height)
    const newHeight = Math.max(120, textarea.scrollHeight); // Minimum 120px
    textarea.style.height = newHeight + "px";
  }

  function setupOverallCommentsHandlers() {
    const myCommentsTextarea = document.getElementById("myOverallComments");
    const managerCommentsTextarea = document.getElementById(
      "managerOverallComments"
    );

    if (myCommentsTextarea) {
      // Save on blur (when user clicks out of the textarea)
      myCommentsTextarea.addEventListener("blur", async function () {
        if (!myCommentsTextarea.readOnly) {
          await saveEmployeeOverallComments(myCommentsTextarea.value);
        }
      });

      // Auto-resize on input
      myCommentsTextarea.addEventListener("input", function () {
        autoResizeTextarea(this);
      });
    }

    if (managerCommentsTextarea) {
      // Save manager comments on blur
      managerCommentsTextarea.addEventListener("blur", async function () {
        if (!managerCommentsTextarea.readOnly) {
          await saveManagerOverallComments(managerCommentsTextarea.value);
        }
      });

      // Auto-resize on input
      managerCommentsTextarea.addEventListener("input", function () {
        autoResizeTextarea(this);
      });
    }
  }

  async function saveEmployeeOverallComments(comments) {
    try {
      console.log("Saving employee overall comments:", comments);

      const response = await fetch(
        `http://localhost:3001/api/goals/overall-employee-comments`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            employee_id: EMPLOYEE_ID,
            employee_overall_comments: comments,
          }),
        }
      );

      if (response.ok) {
        console.log("Employee overall comments saved successfully");
      } else {
        const errorData = await response.text();
        console.error("Failed to save employee overall comments:", errorData);
      }
    } catch (error) {
      console.error("Error saving employee overall comments:", error);
    }
  }

  function displayRatingScale(ratingScale) {
    // Add rating scale reference to the page if needed
    console.log("Rating scale:", ratingScale);
  }

  window.rateGoalAsManager = function (goalId) {
    console.log("Rating goal as manager:", goalId);

    // Create rating modal/form for manager rating
    const ratingOptions = [
      { value: 1, label: "1 - Needs Improvement" },
      { value: 2, label: "2 - Below Expectations" },
      { value: 3, label: "3 - Meets Expectations" },
      { value: 4, label: "4 - Exceeds Expectations" },
      { value: 5, label: "5 - Outstanding" },
    ];

    let ratingHTML =
      '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
    ratingOptions.forEach((option) => {
      ratingHTML += `
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="radio" name="managerRating" value="${option.value}" style="margin: 0;" onchange="saveManagerRatingImmediately(${goalId}, ${option.value})">
          <span>${option.label}</span>
        </label>
      `;
    });
    ratingHTML += "</div>";

    const formHTML = `
      <div id="managerRatingModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 10px; max-width: 500px; width: 90%;">
          <h3 style="margin-bottom: 1rem;">Manager Rating for This Goal</h3>
          ${ratingHTML}
          <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
            <button type="button" class="btn btn-outline" onclick="closeManagerRatingModal()">Close</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML("beforeend", formHTML);
  };

  window.closeManagerRatingModal = function () {
    const modal = document.getElementById("managerRatingModal");
    if (modal) {
      modal.remove();
    }
  };

  window.saveManagerRatingImmediately = async function (goalId, rating) {
    console.log(
      "Saving manager rating immediately for goal:",
      goalId,
      "Rating:",
      rating
    );

    try {
      const response = await fetch(
        `http://localhost:3001/api/goals/${goalId}/manager-rating`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            manager_rating: parseInt(rating),
          }),
        }
      );

      if (response.ok) {
        console.log("Manager rating saved successfully");
        // Close modal after successful save
        setTimeout(() => {
          closeManagerRatingModal();
        }, 500); // Small delay to show the selection
        // Reload goals data to show updated rating
        await loadGoalsData();
      } else {
        const errorData = await response.text();
        console.error("Failed to save manager rating:", errorData);
        alert("Failed to save manager rating: " + errorData);
      }
    } catch (error) {
      console.error("Error saving manager rating:", error);
      alert(
        "Error saving manager rating: " +
          (error instanceof Error ? error.message : "Unknown error")
      );
    }
  };

  window.rateGoalAsEmployee = function (goalId) {
    console.log("Rating goal as employee:", goalId);

    // Create rating modal/form for employee rating
    const ratingOptions = [
      { value: 1, label: "1 - Needs Improvement" },
      { value: 2, label: "2 - Below Expectations" },
      { value: 3, label: "3 - Meets Expectations" },
      { value: 4, label: "4 - Exceeds Expectations" },
      { value: 5, label: "5 - Outstanding" },
    ];

    let ratingHTML =
      '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
    ratingOptions.forEach((option) => {
      ratingHTML += `
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="radio" name="employeeRating" value="${option.value}" style="margin: 0;" onchange="saveEmployeeRatingImmediately(${goalId}, ${option.value})">
          <span>${option.label}</span>
        </label>
      `;
    });
    ratingHTML += "</div>";

    const formHTML = `
      <div id="employeeRatingModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 10px; max-width: 500px; width: 90%;">
          <h3 style="margin-bottom: 1rem;">My Rating for This Goal</h3>
          ${ratingHTML}
          <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
            <button type="button" class="btn btn-outline" onclick="closeEmployeeRatingModal()">Close</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML("beforeend", formHTML);
  };

  window.closeEmployeeRatingModal = function () {
    const modal = document.getElementById("employeeRatingModal");
    if (modal) {
      modal.remove();
    }
  };

  window.saveEmployeeRatingImmediately = async function (goalId, rating) {
    console.log(
      "Saving employee rating immediately for goal:",
      goalId,
      "Rating:",
      rating
    );

    try {
      const response = await fetch(
        `http://localhost:3001/api/goals/${goalId}/employee-rating`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            employee_rating: parseInt(rating),
          }),
        }
      );

      if (response.ok) {
        console.log("Employee rating saved successfully");
        // Close modal after successful save
        setTimeout(() => {
          closeEmployeeRatingModal();
        }, 500); // Small delay to show the selection
        // Reload goals data to show updated rating
        await loadGoalsData();
      } else {
        const errorData = await response.text();
        console.error("Failed to save employee rating:", errorData);
        alert("Failed to save employee rating: " + errorData);
      }
    } catch (error) {
      console.error("Error saving employee rating:", error);
      alert(
        "Error saving employee rating: " +
          (error instanceof Error ? error.message : "Unknown error")
      );
    }
  };

  // Toggle section collapse/expand
  window.toggleManagerGoals = function () {
    const content = document.getElementById("managerGoalsContent");
    const toggle = document.getElementById("manager-toggle");

    if (content && toggle) {
      if (content.classList.contains("collapsed")) {
        content.classList.remove("collapsed");
        toggle.textContent = "−";
      } else {
        content.classList.add("collapsed");
        toggle.textContent = "+";
      }
    }
  };

  window.toggleMyGoals = function () {
    const content = document.getElementById("myGoalsContent");
    const toggle = document.getElementById("my-toggle");

    if (content && toggle) {
      if (content.classList.contains("collapsed")) {
        content.classList.remove("collapsed");
        toggle.textContent = "−";
      } else {
        content.classList.add("collapsed");
        toggle.textContent = "+";
      }
    }
  };

  // Edit toggle functions for overall comments
  window.toggleMyOverallCommentsEdit = function () {
    const textarea = document.getElementById("myOverallComments");
    const button = document.getElementById("myCommentsEditBtn");

    if (textarea && button) {
      if (textarea.readOnly) {
        // Enable editing
        textarea.readOnly = false;
        textarea.style.background = "white";
        button.textContent = "Save";
        textarea.focus();
      } else {
        // Save and disable editing
        saveEmployeeOverallComments(textarea.value);
        textarea.readOnly = true;
        textarea.style.background = "var(--gray-50)";
        button.textContent = "Edit";
      }
    }
  };

  window.toggleManagerOverallCommentsEdit = function () {
    const textarea = document.getElementById("managerOverallComments");
    const button = document.getElementById("managerCommentsEditBtn");

    if (textarea && button) {
      if (textarea.readOnly) {
        // Enable editing
        textarea.readOnly = false;
        textarea.style.background = "white";
        button.textContent = "Save";
        textarea.focus();
      } else {
        // Save and disable editing
        saveManagerOverallComments(textarea.value);
        textarea.readOnly = true;
        textarea.style.background = "var(--gray-50)";
        button.textContent = "Edit";
      }
    }
  };

  async function saveManagerOverallComments(comments) {
    try {
      console.log("Saving manager overall comments:", comments);

      const response = await fetch(
        `http://localhost:3001/api/goals/overall-manager-comments`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            employee_id: EMPLOYEE_ID,
            manager_overall_comments: comments,
          }),
        }
      );

      if (response.ok) {
        console.log("Manager overall comments saved successfully");
      } else {
        const errorData = await response.text();
        console.error("Failed to save manager overall comments:", errorData);
      }
    } catch (error) {
      console.error("Error saving manager overall comments:", error);
    }
  }

  // Overall rating functions
  window.rateOverallSelf = function () {
    console.log("Opening overall self-rating modal");

    // Create rating modal for overall self-rating
    const ratingScale = window.goalsData?.ratingScale || [
      { rating_value: 1, rating_label: "Does Not Meet Expectations" },
      { rating_value: 2, rating_label: "Partially Meets Expectations" },
      { rating_value: 3, rating_label: "Meets Expectations" },
      { rating_value: 4, rating_label: "Exceeds Expectations" },
      { rating_value: 5, rating_label: "Outstanding" },
    ];

    const modalHtml = `
      <div id="overallSelfRatingModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 10px; max-width: 500px; width: 90%;">
          <h3 style="margin-bottom: 1rem;">Overall Self-Rating</h3>
          <div style="margin-bottom: 1rem;">
            ${ratingScale
              .map(
                (option) => `
              <label style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                <input type="radio" name="overallSelfRating" value="${option.rating_value}" style="margin: 0;" onchange="saveOverallSelfRating(${option.rating_value})">
                <span style="margin-left: 0.5rem;">${option.rating_value} - ${option.rating_label}</span>
              </label>
            `
              )
              .join("")}
          </div>
          <div style="text-align: right;">
            <button type="button" class="btn btn-outline" onclick="closeOverallSelfRatingModal()">Close</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML("beforeend", modalHtml);
  };

  window.closeOverallSelfRatingModal = function () {
    const modal = document.getElementById("overallSelfRatingModal");
    if (modal) {
      modal.remove();
    }
  };

  window.saveOverallSelfRating = async function (rating) {
    try {
      console.log("Saving overall self rating:", rating);

      const response = await fetch(
        `http://localhost:3001/api/goals/overall-employee-rating`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            employee_id: EMPLOYEE_ID,
            overall_employee_rating: parseInt(rating),
          }),
        }
      );

      if (response.ok) {
        console.log("Overall self rating saved successfully");

        // Close modal
        closeOverallSelfRatingModal();

        // Reload to get updated data
        loadGoalsData();
      } else {
        const errorData = await response.text();
        console.error("Failed to save overall self rating:", errorData);
        alert("Failed to save overall self rating: " + errorData);
      }
    } catch (error) {
      console.error("Error saving overall self rating:", error);
      alert(
        "Error saving overall self rating: " +
          (error.message || "Unknown error")
      );
    }
  };

  window.rateOverallAsManager = function () {
    console.log("Opening overall manager rating modal");

    // Create rating modal for overall manager rating
    const ratingScale = window.goalsData?.ratingScale || [
      { rating_value: 1, rating_label: "Does Not Meet Expectations" },
      { rating_value: 2, rating_label: "Partially Meets Expectations" },
      { rating_value: 3, rating_label: "Meets Expectations" },
      { rating_value: 4, rating_label: "Exceeds Expectations" },
      { rating_value: 5, rating_label: "Outstanding" },
    ];

    const modalHtml = `
      <div id="overallManagerRatingModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 10px; max-width: 500px; width: 90%;">
          <h3 style="margin-bottom: 1rem;">Overall Manager Rating</h3>
          <div style="margin-bottom: 1rem;">
            ${ratingScale
              .map(
                (option) => `
              <label style="display: block; margin-bottom: 0.5rem; cursor: pointer;">
                <input type="radio" name="overallManagerRating" value="${option.rating_value}" style="margin: 0;" onchange="saveOverallManagerRating(${option.rating_value})">
                <span style="margin-left: 0.5rem;">${option.rating_value} - ${option.rating_label}</span>
              </label>
            `
              )
              .join("")}
          </div>
          <div style="text-align: right;">
            <button type="button" class="btn btn-outline" onclick="closeOverallManagerRatingModal()">Close</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML("beforeend", modalHtml);
  };

  window.closeOverallManagerRatingModal = function () {
    const modal = document.getElementById("overallManagerRatingModal");
    if (modal) {
      modal.remove();
    }
  };

  window.saveOverallManagerRating = async function (rating) {
    try {
      console.log("Saving overall manager rating:", rating);

      const response = await fetch(
        `http://localhost:3001/api/goals/overall-manager-rating`,
        {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            employee_id: EMPLOYEE_ID,
            overall_manager_rating: parseInt(rating),
          }),
        }
      );

      if (response.ok) {
        console.log("Overall manager rating saved successfully");

        // Close modal
        closeOverallManagerRatingModal();

        // Reload to get updated data
        loadGoalsData();
      } else {
        const errorData = await response.text();
        console.error("Failed to save overall manager rating:", errorData);
        alert("Failed to save overall manager rating: " + errorData);
      }
    } catch (error) {
      console.error("Error saving overall manager rating:", error);
      alert(
        "Error saving overall manager rating: " +
          (error.message || "Unknown error")
      );
    }
  };

  // Navigation function for pills
  window.navigateToPhase = function (phase) {
    console.log("Navigating to phase:", phase);

    if (phase === "build-plan") {
      window.location.href = "/goals";
    } else if (phase === "mid-year") {
      window.location.href = "/midyear";
    } else if (phase === "end-of-year") {
      // Already on end-of-year page, just reload if needed
      return;
    }
  };

  // Handle collapsible goal cards
  document.addEventListener("click", function (event) {
    const target = event.target as HTMLElement;

    // Check if clicked element or its parent is a toggle button
    let button = null;
    if (target.classList && target.classList.contains("toggle-goal-btn")) {
      button = target;
    } else if (
      target.parentElement &&
      target.parentElement.classList &&
      target.parentElement.classList.contains("toggle-goal-btn")
    ) {
      button = target.parentElement;
    }

    if (button) {
      const goalId = button.getAttribute("data-goal-id");
      const detailsDiv = document.getElementById(`details-${goalId}`);
      const icon = button.querySelector(".toggle-icon");

      if (detailsDiv && icon) {
        if (detailsDiv.style.display === "none") {
          detailsDiv.style.display = "block";
          icon.textContent = "\u2212";
        } else {
          detailsDiv.style.display = "none";
          icon.textContent = "+";
        }
      }
    }
  });

  // Load goals data when page loads
  document.addEventListener("DOMContentLoaded", loadGoalsData);

  // Also load immediately if DOM is already ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", loadGoalsData);
  } else {
    loadGoalsData();
  }
</script>

<style>
  .collapsed {
    display: none;
  }

  .loading {
    color: var(--gray-500);
    font-style: italic;
    padding: 1rem;
    text-align: center;
  }

  .pill.active {
    background: var(--blue-primary);
    color: white;
    border-color: var(--blue-primary);
  }

  .pill.disabled {
    background: var(--gray-200);
    color: var(--gray-500);
    border-color: var(--gray-200);
    cursor: not-allowed;
  }
</style>
