---
import DefaultLayout from "../layouts/DefaultLayout.astro";
---

<DefaultLayout title="End-of-Year Review">
  <section class="workspace-header">
    <h1>End-of-Year Review</h1>
  </section>

  <section class="workspace-content">
    <!-- State Navigation -->
    <div class="card" style="grid-column: span 12;">
      <div style="display: flex; justify-content: center; gap: 0.5rem;">
        <div class="pill" onclick="navigateToPhase('build-plan')">Build Plan</div>
        <div class="pill" onclick="navigateToPhase('mid-year')">Mid-Year Review</div>
        <div class="pill active" onclick="navigateToPhase('end-of-year')">End-of-Year Review</div>
      </div>
    </div>

    <!-- Manager Goals Section (Read Only) -->
    <div class="card" style="grid-column: span 12;">
      <div
        style="display: flex; justify-content: space-between; align-items: center;"
      >
        <h3>Manager Goals</h3>
        <button
          type="button"
          class="btn btn-sm btn-outline"
          onclick="toggleManagerGoals()"
        >
          <span id="manager-toggle">−</span>
        </button>
      </div>
      <div id="managerGoalsContent">
        <div id="managerGoalsSection">
          <div class="loading">Loading manager goals...</div>
        </div>
      </div>
    </div>

    <!-- My Goals Section (View Ratings & Manager Rating) -->
    <div class="card" style="grid-column: span 12;">
      <div
        style="display: flex; justify-content: space-between; align-items: center;"
      >
        <h3>My Goals - Final Review</h3>
        <button
          type="button"
          class="btn btn-sm btn-outline"
          onclick="toggleMyGoals()"
        >
          <span id="my-toggle">−</span>
        </button>
      </div>
      <div id="myGoalsContent">
        <div id="myGoalsSection">
          <div class="loading">Loading your goals...</div>
        </div>
      </div>
    </div>
  </section>
</DefaultLayout>

<script>
  const EMPLOYEE_ID = 301;
  let currentState = "end-year";

  console.log("End-of-Year Review script started");

  async function loadGoalsData() {
    try {
      console.log("Loading goals data for end-of-year review...");
      const url = `http://localhost:3001/api/goals?employee_id=${EMPLOYEE_ID}&state=${currentState}`;
      console.log("Fetching from URL:", url);

      const response = await fetch(url);
      console.log("Response status:", response.status);
      console.log("Response ok:", response.ok);

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();
      console.log("Goals data received:", data);

      // Store globally for other functions
      window.goalsData = data;

      // Display manager goals (read-only)
      displayManagerGoals(data.managerGoals || []);

      // Display employee goals with both ratings
      displayMyGoalsWithBothRatings(data.myGoals || []);

      // Show rating scale
      displayRatingScale(data.ratingScale || []);

    } catch (error) {
      console.error("Error loading goals data:", error);
      const managerSection = document.getElementById("managerGoalsSection");
      const mySection = document.getElementById("myGoalsSection");

      if (managerSection) {
        managerSection.innerHTML = 
          '<div style="color: red; padding: 1rem;">Error loading manager goals: ' + 
          (error instanceof Error ? error.message : "Unknown error") + '</div>';
      }

      if (mySection) {
        mySection.innerHTML = 
          '<div style="color: red; padding: 1rem;">Error loading your goals: ' + 
          (error instanceof Error ? error.message : "Unknown error") + '</div>';
      }
    }
  }

  function displayManagerGoals(managerGoals) {
    console.log("displayManagerGoals called with:", managerGoals);
    const section = document.getElementById("managerGoalsSection");

    if (!managerGoals || managerGoals.length === 0) {
      section.innerHTML =
        '<div style="color: var(--gray-500); font-style: italic; padding: 1rem; text-align: center;">No manager goals available for this review period.</div>';
      return;
    }

    // Sort goals alphabetically by strategy name
    const sortedManagerGoals = [...managerGoals].sort((a, b) => {
      const strategyA = (a.strategy_name || "").toLowerCase();
      const strategyB = (b.strategy_name || "").toLowerCase();
      return strategyA.localeCompare(strategyB);
    });

    let html =
      '<div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem;">';
    sortedManagerGoals.forEach((goal, index) => {
      const goalId = `manager-goal-${index}`;
      html += `
        <div style="padding: 1rem; border: 1px solid var(--gray-200); border-radius: 10px; background: var(--gray-50);">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div style="flex: 1; display: flex; gap: 2rem;">
              <div style="flex: 1;">
                <h3 style="margin-bottom: 0.4rem;">Strategy</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.strategy_name || "No strategy specified"}</div>
              </div>
              <div style="flex: 3;">
                <h3 style="margin-bottom: 0.4rem;">Objective</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.objective || "Untitled Goal"}</div>
              </div>
              <div style="flex: 1; margin-left: 2rem;">
                <h3 style="margin-bottom: 0.4rem;">Date</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${
                  goal.target_date && goal.target_date !== "null"
                    ? (() => {
                        try {
                          const dateStr = goal.target_date.split("T")[0];
                          return new Date(
                            dateStr + "T12:00:00"
                          ).toLocaleDateString();
                        } catch (e) {
                          return "Invalid date";
                        }
                      })()
                    : "No date set"
                }</div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
              <button class="btn btn-sm btn-outline toggle-goal-btn" data-goal-id="${goalId}">
                <span class="toggle-icon">\u2212</span>
              </button>
            </div>
          </div>
          <div id="details-${goalId}" style="margin-top: 1rem;">
            <div>
              <h3 style="margin-bottom: 0.4rem;">Description</h3>
              <div style="font-size: 1rem; font-weight: 500; color: var(--gray-700); line-height: 1.3;">${goal.goal_description || "No description provided"}</div>
            </div>
          </div>
        </div>
      `;
    });
    html += "</div>";

    section.innerHTML = html;
  }

  function displayMyGoalsWithBothRatings(myGoals) {
    console.log("displayMyGoalsWithBothRatings called with:", myGoals);
    const mySection = document.getElementById("myGoalsSection");

    if (!myGoals || myGoals.length === 0) {
      mySection.innerHTML =
        '<div style="color: var(--gray-500); font-style: italic; padding: 1rem; text-align: center;">No goals found for end-of-year review.</div>';
      return;
    }

    // Sort goals alphabetically by strategy name
    const sortedMyGoals = [...myGoals].sort((a, b) => {
      const strategyA = (a.strategy_name || "").toLowerCase();
      const strategyB = (b.strategy_name || "").toLowerCase();
      return strategyA.localeCompare(strategyB);
    });

    let html =
      '<div style="display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem;">';
    sortedMyGoals.forEach((goal, index) => {
      const goalId = `my-goal-${index}`;
      html += `
        <div style="padding: 1rem; border: 1px solid var(--gray-200); border-radius: 10px; background: var(--gray-50);" data-goal-id="${goal.goal_id}">
          <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
            <div style="flex: 1; display: flex; gap: 2rem;">
              <div style="flex: 1;">
                <h3 style="margin-bottom: 0.4rem;">Strategy</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.strategy_name || "No strategy specified"}</div>
              </div>
              <div style="flex: 3;">
                <h3 style="margin-bottom: 0.4rem;">Objective</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">${goal.objective || "Untitled Goal"}</div>
              </div>
              <div style="flex: 1; margin-left: 2rem; text-align: center;">
                <h3 style="margin-bottom: 0.4rem;">My Rating</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--blue-primary); line-height: 1.3;">
                  ${goal.employee_rating || "Not rated"}
                </div>
                <h3 style="margin-bottom: 0.4rem; margin-top: 1rem;">Manager Rating</h3>
                <div style="font-size: 1rem; font-weight: 600; color: var(--green-primary); line-height: 1.3;">
                  ${goal.manager_rating || "Pending"}
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-left: 1rem;">
              <button class="btn btn-sm btn-outline" onclick="rateGoalAsManager(${goal.goal_id})">Rate as Manager</button>
              <button class="btn btn-sm btn-outline toggle-goal-btn" data-goal-id="${goalId}">
                <span class="toggle-icon">\u2212</span>
              </button>
            </div>
          </div>
          <div id="details-${goalId}" style="margin-top: 1rem;">
            <div>
              <h3 style="margin-bottom: 0.4rem;">Description</h3>
              <div style="font-size: 1rem; font-weight: 500; color: var(--gray-700); line-height: 1.3;">${goal.goal_description || "No description provided"}</div>
            </div>
          </div>
        </div>
      `;
    });
    html += "</div>";

    mySection.innerHTML = html;
  }

  function displayRatingScale(ratingScale) {
    // Add rating scale reference to the page if needed
    console.log("Rating scale:", ratingScale);
  }

  window.rateGoalAsManager = function(goalId) {
    console.log("Rating goal as manager:", goalId);
    
    // Create rating modal/form for manager rating
    const ratingOptions = [
      { value: 1, label: "1 - Needs Improvement" },
      { value: 2, label: "2 - Below Expectations" },
      { value: 3, label: "3 - Meets Expectations" },
      { value: 4, label: "4 - Exceeds Expectations" },
      { value: 5, label: "5 - Outstanding" }
    ];

    let ratingHTML = '<div style="display: flex; flex-direction: column; gap: 0.5rem;">';
    ratingOptions.forEach(option => {
      ratingHTML += `
        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
          <input type="radio" name="managerRating" value="${option.value}" style="margin: 0;" onchange="saveManagerRatingImmediately(${goalId}, ${option.value})">
          <span>${option.label}</span>
        </label>
      `;
    });
    ratingHTML += '</div>';

    const formHTML = `
      <div id="managerRatingModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;">
        <div style="background: white; padding: 2rem; border-radius: 10px; max-width: 500px; width: 90%;">
          <h3 style="margin-bottom: 1rem;">Manager Rating for This Goal</h3>
          ${ratingHTML}
          <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: flex-end;">
            <button type="button" class="btn btn-outline" onclick="closeManagerRatingModal()">Close</button>
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', formHTML);
  };

  window.closeManagerRatingModal = function() {
    const modal = document.getElementById('managerRatingModal');
    if (modal) {
      modal.remove();
    }
  };

  window.saveManagerRatingImmediately = async function(goalId, rating) {
    console.log("Saving manager rating immediately for goal:", goalId, "Rating:", rating);

    try {
      const response = await fetch(`http://localhost:3001/api/goals/${goalId}/manager-rating`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          manager_rating: parseInt(rating)
        })
      });

      if (response.ok) {
        console.log("Manager rating saved successfully");
        // Close modal after successful save
        setTimeout(() => {
          closeManagerRatingModal();
        }, 500); // Small delay to show the selection
        // Reload goals data to show updated rating
        await loadGoalsData();
      } else {
        const errorData = await response.text();
        console.error("Failed to save manager rating:", errorData);
        alert("Failed to save manager rating: " + errorData);
      }
    } catch (error) {
      console.error("Error saving manager rating:", error);
      alert("Error saving manager rating: " + (error instanceof Error ? error.message : "Unknown error"));
    }
  };

  // Toggle section collapse/expand
  window.toggleManagerGoals = function () {
    const content = document.getElementById("managerGoalsContent");
    const toggle = document.getElementById("manager-toggle");

    if (content && toggle) {
      if (content.classList.contains("collapsed")) {
        content.classList.remove("collapsed");
        toggle.textContent = "−";
      } else {
        content.classList.add("collapsed");
        toggle.textContent = "+";
      }
    }
  };

  window.toggleMyGoals = function () {
    const content = document.getElementById("myGoalsContent");
    const toggle = document.getElementById("my-toggle");

    if (content && toggle) {
      if (content.classList.contains("collapsed")) {
        content.classList.remove("collapsed");
        toggle.textContent = "−";
      } else {
        content.classList.add("collapsed");
        toggle.textContent = "+";
      }
    }
  };

  // Navigation function for pills
  window.navigateToPhase = function(phase) {
    console.log('Navigating to phase:', phase);
    
    if (phase === 'build-plan') {
      window.location.href = '/goals';
    } else if (phase === 'mid-year') {
      window.location.href = '/midyear';
    } else if (phase === 'end-of-year') {
      // Already on end-of-year page, just reload if needed
      return;
    }
  };

  // Handle collapsible goal cards
  document.addEventListener("click", function (event) {
    const target = event.target as HTMLElement;

    // Check if clicked element or its parent is a toggle button
    let button = null;
    if (target.classList && target.classList.contains("toggle-goal-btn")) {
      button = target;
    } else if (
      target.parentElement &&
      target.parentElement.classList &&
      target.parentElement.classList.contains("toggle-goal-btn")
    ) {
      button = target.parentElement;
    }

    if (button) {
      const goalId = button.getAttribute("data-goal-id");
      const detailsDiv = document.getElementById(`details-${goalId}`);
      const icon = button.querySelector(".toggle-icon");

      if (detailsDiv && icon) {
        if (detailsDiv.style.display === "none") {
          detailsDiv.style.display = "block";
          icon.textContent = "\u2212";
        } else {
          detailsDiv.style.display = "none";
          icon.textContent = "+";
        }
      }
    }
  });

  // Load goals data when page loads
  document.addEventListener("DOMContentLoaded", loadGoalsData);
  
  // Also load immediately if DOM is already ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", loadGoalsData);
  } else {
    loadGoalsData();
  }
</script>

<style>
  .collapsed {
    display: none;
  }

  .loading {
    color: var(--gray-500);
    font-style: italic;
    padding: 1rem;
    text-align: center;
  }

  .pill.active {
    background: var(--blue-primary);
    color: white;
    border-color: var(--blue-primary);
  }

  .pill.disabled {
    background: var(--gray-200);
    color: var(--gray-500);
    border-color: var(--gray-200);
    cursor: not-allowed;
  }
</style>